var e=Object.defineProperty,t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,o=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,i=(e,i)=>{for(var a in i||(i={}))n.call(i,a)&&o(e,a,i[a]);if(t)for(var a of t(i))r.call(i,a)&&o(e,a,i[a]);return e};import{D as a,R as l,a as u}from"./RichTextSetting-rzzXsKhr.js";import{P as c}from"./PageWrapper-_w1STvok.js";import{dq as s,dr as h,y as f,d as g,r as d,l as p,e as m,c as v,a as y,Z as w,F as x,B as b,k as P,ds as C,s as A}from"./index-hPCwy2cU.js";import{U as E}from"./UploadImage-l81TzQnH.js";import{g as S,a as j}from"./image-UzVMQwv3.js";import{C as T}from"./index--VM6Akgl.js";import{R as I,C as k}from"./index-PlvNFPZL.js";import"./vue-drag-resize-eWpad9Ky.js";import"./index-Fa6AgMat.js";import"./List-teIXDyNS.js";import"./isMobile-aGnBD7or.js";import"./useMergedState-VhlIxWjY.js";import"./CheckOutlined-WBtOhnNS.js";import"./index-Z5-e6Vuq.js";import"./partition-MJYMOLMf.js";import"./DeleteOutlined-fsmw97KG.js";const U={x:300,y:100,z:1,w:180,h:36,type:"text",tag:"text_1",active:!1,text:"请输入文本",style:{fontFamily:"微软雅黑",fontSize:"24px",lineHeight:"24px",color:"#f70707",backgroundColor:"#05f8e8",fontWeight:"",fontStyle:"",textShadow:"",textAlign:"left"}},R={x:320,y:300,z:2,w:160,h:160,type:"image",tag:"image_2",active:!1,url:s},L={width:850,height:530,bgImgUrl:h};var B,D={exports:{}};B=D,function(e){var t=function(){return{escape:function(e){return e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:t,mimeType:function(e){var n,r,o=t(e).toLowerCase();return(n="application/font-woff",r="image/jpeg",{woff:n,woff2:n,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:r,jpeg:r,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"})[o]||""},dataAsUrl:function(e,t){return"data:"+t+";base64,"+e},isDataUrl:function(e){return-1!==e.search(/^(data:)/)},canvasToBlob:function(e){return e.toBlob?new Promise((function(t){e.toBlob(t)})):function(e){return new Promise((function(t){for(var n=window.atob(e.toDataURL().split(",")[1]),r=n.length,o=new Uint8Array(r),i=0;i<r;i++)o[i]=n.charCodeAt(i);t(new Blob([o],{type:"image/png"}))}))}(e)},resolveUrl:function(e,t){var n=document.implementation.createHTMLDocument(),r=n.createElement("base");n.head.appendChild(r);var o=n.createElement("a");return n.body.appendChild(o),r.href=t,o.href=e,o.href},getAndEncode:function(e){var t=3e4;return a.impl.options.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime()),new Promise((function(n){var r,o=new XMLHttpRequest;if(o.onreadystatechange=l,o.ontimeout=u,o.responseType="blob",o.timeout=t,o.open("GET",e,!0),o.send(),a.impl.options.imagePlaceholder){var i=a.impl.options.imagePlaceholder.split(/,/);i&&i[1]&&(r=i[1])}function l(){if(4===o.readyState)if(200===o.status){var t=new FileReader;t.onloadend=function(){var e=t.result.split(/,/)[1];n(e)},t.readAsDataURL(o.response)}else r?n(r):c("cannot fetch resource: "+e+", status: "+o.status)}function u(){r?n(r):c("timeout of "+t+"ms occured while fetching resource: "+e)}function c(e){n("")}}))},uid:(e=0,function(){return"u"+t()+e++;function t(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}}),delay:function(e){return function(t){return new Promise((function(n){setTimeout((function(){n(t)}),e)}))}},asArray:function(e){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t},escapeXhtml:function(e){return e.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(e){return new Promise((function(t,n){var r=new Image;r.onload=function(){t(r)},r.onerror=n,r.src=e}))},width:function(e){var t=n(e,"border-left-width"),r=n(e,"border-right-width");return e.scrollWidth+t+r},height:function(e){var t=n(e,"border-top-width"),r=n(e,"border-bottom-width");return e.scrollHeight+t+r}};var e;function t(e){var t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""}function n(e,t){var n=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(n.replace("px",""))}}(),n=function(){var e=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:function(e,t,i){return a()?Promise.resolve(e):Promise.resolve(e).then(r).then((function(n){var r=Promise.resolve(e);return n.forEach((function(e){r=r.then((function(n){return o(n,e,t,i)}))})),r}));function a(){return!n(e)}},shouldProcess:n,impl:{readUrls:r,inline:o}};function n(t){return-1!==t.search(e)}function r(n){for(var r,o=[];null!==(r=e.exec(n));)o.push(r[1]);return o.filter((function(e){return!t.isDataUrl(e)}))}function o(e,n,r,o){return Promise.resolve(n).then((function(e){return r?t.resolveUrl(e,r):e})).then(o||t.getAndEncode).then((function(e){return t.dataAsUrl(e,t.mimeType(n))})).then((function(r){return e.replace((o=n,new RegExp("(url\\(['\"]?)("+t.escape(o)+")(['\"]?\\))","g")),"$1"+r+"$3");var o}))}}(),r=function(){return{resolveAll:function(){return e().then((function(e){return Promise.all(e.map((function(e){return e.resolve()})))})).then((function(e){return e.join("\n")}))},impl:{readAll:e}};function e(){return Promise.resolve(t.asArray(document.styleSheets)).then((function(e){var n=[];return e.forEach((function(e){try{t.asArray(e.cssRules||[]).forEach(n.push.bind(n))}catch(r){}})),n})).then((function(e){return e.filter((function(e){return e.type===CSSRule.FONT_FACE_RULE})).filter((function(e){return n.shouldProcess(e.style.getPropertyValue("src"))}))})).then((function(t){return t.map(e)}));function e(e){return{resolve:function(){var t=(e.parentStyleSheet||{}).href;return n.inlineAll(e.cssText,t)},src:function(){return e.style.getPropertyValue("src")}}}}}(),o=function(){return{inlineAll:function r(o){return o instanceof Element?i(o).then((function(){return o instanceof HTMLImageElement?e(o).inline():Promise.all(t.asArray(o.childNodes).map((function(e){return r(e)})))})):Promise.resolve(o);function i(e){var t=e.style.getPropertyValue("background");return t?n.inlineAll(t).then((function(t){e.style.setProperty("background",t,e.style.getPropertyPriority("background"))})).then((function(){return e})):Promise.resolve(e)}},impl:{newImage:e}};function e(e){return{inline:function(n){return t.isDataUrl(e.src)?Promise.resolve():Promise.resolve(e.src).then(n||t.getAndEncode).then((function(n){return t.dataAsUrl(n,t.mimeType(e.src))})).then((function(t){return new Promise((function(n,r){e.onload=n,e.onerror=r,e.src=t}))}))}}}}(),i={imagePlaceholder:void 0,cacheBust:!1},a={toSvg:l,toPng:function(e,t){return u(e,t||{}).then((function(e){return e.toDataURL()}))},toJpeg:function(e,t){return u(e,t=t||{}).then((function(e){return e.toDataURL("image/jpeg",t.quality||1)}))},toBlob:function(e,n){return u(e,n||{}).then(t.canvasToBlob)},toPixelData:function(e,n){return u(e,n||{}).then((function(n){return n.getContext("2d").getImageData(0,0,t.width(e),t.height(e)).data}))},impl:{fontFaces:r,images:o,util:t,inliner:n,options:{}}};function l(e,n){return function(e){void 0===e.imagePlaceholder?a.impl.options.imagePlaceholder=i.imagePlaceholder:a.impl.options.imagePlaceholder=e.imagePlaceholder,void 0===e.cacheBust?a.impl.options.cacheBust=i.cacheBust:a.impl.options.cacheBust=e.cacheBust}(n=n||{}),Promise.resolve(e).then((function(e){return c(e,n.filter,!0)})).then(s).then(h).then((function(e){return n.bgcolor&&(e.style.backgroundColor=n.bgcolor),n.width&&(e.style.width=n.width+"px"),n.height&&(e.style.height=n.height+"px"),n.style&&Object.keys(n.style).forEach((function(t){e.style[t]=n.style[t]})),e})).then((function(r){return function(e,n,r){return Promise.resolve(e).then((function(e){return e.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(e)})).then(t.escapeXhtml).then((function(e){return'<foreignObject x="0" y="0" width="100%" height="100%">'+e+"</foreignObject>"})).then((function(e){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+n+'" height="'+r+'">'+e+"</svg>"})).then((function(e){return"data:image/svg+xml;charset=utf-8,"+e}))}(r,n.width||t.width(e),n.height||t.height(e))}))}function u(e,n){return l(e,n).then(t.makeImage).then(t.delay(100)).then((function(r){var o=function(e){var r=document.createElement("canvas");if(r.width=n.width||t.width(e),r.height=n.height||t.height(e),n.bgcolor){var o=r.getContext("2d");o.fillStyle=n.bgcolor,o.fillRect(0,0,r.width,r.height)}return r}(e);return o.getContext("2d").drawImage(r,0,0),o}))}function c(e,n,r){return r||!n||n(e)?Promise.resolve(e).then((function(e){return e instanceof HTMLCanvasElement?t.makeImage(e.toDataURL()):e.cloneNode(!1)})).then((function(r){return function(e,n,r){var o=e.childNodes;return 0===o.length?Promise.resolve(n):i(n,t.asArray(o),r).then((function(){return n}));function i(e,t,n){var r=Promise.resolve();return t.forEach((function(t){r=r.then((function(){return c(t,n)})).then((function(t){t&&e.appendChild(t)}))})),r}}(e,r,n)})).then((function(n){return function(e,n){return n instanceof Element?Promise.resolve().then(r).then(o).then(i).then(a).then((function(){return n})):n;function r(){function r(e,n){function r(e,n){t.asArray(e).forEach((function(t){n.setProperty(t,e.getPropertyValue(t),e.getPropertyPriority(t))}))}e.cssText?n.cssText=e.cssText:r(e,n)}r(window.getComputedStyle(e),n.style)}function o(){function r(r){var o=window.getComputedStyle(e,r),i=o.getPropertyValue("content");if(""!==i&&"none"!==i){var a=t.uid();n.className=n.className+" "+a;var l=document.createElement("style");l.appendChild(u(a,r,o)),n.appendChild(l)}function u(e,n,r){var o="."+e+":"+n,i=r.cssText?a(r):l(r);return document.createTextNode(o+"{"+i+"}");function a(e){var t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"}function l(e){return t.asArray(e).map(n).join("; ")+";";function n(t){return t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")}}}}[":before",":after"].forEach((function(e){r(e)}))}function i(){e instanceof HTMLTextAreaElement&&(n.innerHTML=e.value),e instanceof HTMLInputElement&&n.setAttribute("value",e.value)}function a(){n instanceof SVGElement&&(n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n instanceof SVGRectElement&&["width","height"].forEach((function(e){var t=n.getAttribute(e);t&&n.style.setProperty(e,t)})))}}(e,n)})):Promise.resolve()}function s(e){return r.resolveAll().then((function(t){var n=document.createElement("style");return e.appendChild(n),n.appendChild(document.createTextNode(t)),e}))}function h(e){return o.inlineAll(e).then((function(){return e}))}B.exports=a}();const M=f(D.exports),O=g({name:"ImageComposition",setup(){var e;const t=d(L),n=p([U,R]),r=p((null==(e=n.value[0])?void 0:e.tag)||""),o=p(n.value.length),s=m((()=>({position:"relative",width:t.width+"px",height:t.height+"px",backgroundImage:`url(${t.bgImgUrl})`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat"}))),h=m((()=>n.value.find((e=>e.tag===r.value)))),f=m((()=>{var e;return"text"===(null==(e=h.value)?void 0:e.type)?h.value:null})),g=()=>{const e=++o.value,t={x:300,y:100,z:n.value.length,w:180,h:36,type:"text",tag:`text_${e}`,active:!1,text:"请输入文本",style:{fontFamily:"微软雅黑",fontSize:"24px",lineHeight:"24px",color:"#f70707",backgroundColor:"#05f8e8",fontWeight:"",fontStyle:"",textShadow:"",textAlign:"left"}};n.value.length>4?A.warning("图片上最多叠加5个元素!"):(n.value.push(t),r.value=t.tag)},B=()=>{if(!y(r))return void A.warning("请先选择元素!");const e=n.value.findIndex((e=>e.tag===y(r)));n.value.splice(e,1),r.value=""},D=e=>{S(e).then((({width:n,height:r})=>{const{width:o,height:i}=j(n,r,850,550);t.bgImgUrl=e,t.width=o,t.height=i}))},O=e=>{S(e).then((({width:i,height:a})=>{const{width:l,height:u}=j(i,a,Math.floor(t.width/4),Math.floor(t.height/4));(e=>{const t=++o.value,i={x:320,y:300,z:n.value.length,w:e.width,h:e.height,type:"image",tag:`image_${t}`,active:!1,url:e.url};n.value.length>4?A.warning("图片上最多叠加5个元素!"):(n.value.push(i),r.value=U.tag)})({url:e,width:l,height:u})}))},V=()=>{return e=this,t=null,n=function*(){M.toPng(document.getElementById("imageComposition")).then((e=>{const t=document.createElement("a");t.href=e,t.download="composition-image.png",t.click()}))},new Promise(((r,o)=>{var i=e=>{try{l(n.next(e))}catch(t){o(t)}},a=e=>{try{l(n.throw(e))}catch(t){o(t)}},l=e=>e.done?r(e.value):Promise.resolve(e.value).then(i,a);l((n=n.apply(e,t)).next())}));var e,t,n};return()=>v(c,{plugin:C},{default:()=>[v(I,{gutter:12},{default:()=>[v(k,{span:16},{default:()=>[v(T,{title:"合成区域",bodyStyle:{height:"600px"}},{default:()=>[v("div",{class:"flex-center"},[v("div",{id:"imageComposition",class:"dnd-container",style:i({},y(s))},[n.value.map(((e,t)=>{return v(a,{key:e.tag,element:e,handlers:(o=e.type,"text"===o?["e","w"]:["n","e","s","w","ne","nw","se","sw"]),onChange:e=>((e,t)=>{n.value[t]=e,e.active&&(r.value=e.tag,n.value.forEach((t=>{t.tag!==e.tag&&(t.active=!1)})))})(e,t)},{default:()=>["text"===e.type?v(l,{value:e.text,"onUpdate:value":t=>e.text=t,style:e.style},null):"image"===e.type?v("img",{src:e.url,draggable:"false"},null):v(w,null,null)]});var o}))])])]})]}),v(k,{span:8},{default:()=>[v(T,{title:"设置区域",bodyStyle:{height:"600px"}},{default:()=>{var e,t;return[v(x,{colon:!1,labelCol:{span:6},wrapperCol:{span:18},labelAlign:"left",style:{width:"300px",margin:"0 auto"}},{default:()=>[v(x.Item,{label:"选择底图"},{default:()=>[v(E,{name:"选择底图",isFull:!0,onSuccess:D},null)]}),v(x.Item,{label:"添加文本"},{default:()=>[v(b,{block:!0,style:{width:"100%"},onClick:g},{default:()=>[P("添加文本")]})]}),v(x.Item,{label:"添加图片"},{default:()=>[v(E,{name:"添加图片",isFull:!0,onSuccess:O},null)]}),v(x.Item,{label:"删除元素"},{default:()=>[v(b,{type:"primary",danger:!0,style:{width:"100%"},onClick:B},{default:()=>[P("删除元素")]})]})]}),y(f)?v(u,{textValue:null==(e=y(f))?void 0:e.text,textStyles:null==(t=y(f))?void 0:t.style,onChangeValue:e=>(e=>{n.value.forEach((t=>{t.tag===y(r)&&(t.text=e)}))})(e),onChangeStyles:e=>(e=>{n.value.forEach((t=>{t.tag===y(r)&&(t.style=e)}))})(e)},null):v(w,null,null),v("div",{style:{width:"300px",margin:"0 auto"}},[v(b,{type:"primary",style:{width:"100%"},onClick:V},{default:()=>[P("合成图片")]})])]}})]})]})]})}});export{O as default};
